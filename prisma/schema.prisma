// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Site {
  id               String   @id // "PRJ001"
  name             String
  country          String
  timezone         String
  baselineKgPerKWh Float    // grid emission factor
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  rawTelemetry     RawTelemetry[]
  hourlySummaries  HourlySummary[]
  dailyDigests     DailyDigest[]

  @@map("sites")
}

model RawTelemetry {
  id         String   @id @default(cuid())
  siteId     String
  tsUtc      DateTime // measurement end time
  poaIrrWm2  Float?
  tempC      Float?
  windMps    Float?
  acPowerKw  Float?
  acEnergyKWh Float? // interval kWh
  status     String? // OK/OUTAGE/CURTAILED
  rowHash    String  // sha256 normalized row
  source     String  // "mqtt" | "http" | "pull"
  uniqKey    String? // optional source idempotency key
  createdAt  DateTime @default(now())

  // Relations
  site       Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, tsUtc]) // one row per interval per site
  @@index([siteId, createdAt])
  @@map("raw_telemetry")
}

model HourlySummary {
  id        String   @id @default(cuid())
  siteId    String
  hourUtc   DateTime
  energyKWh Float
  maxPowerKw Float?
  avgTempC  Float?
  avgIrrWm2 Float?
  rows      Int
  createdAt DateTime @default(now())

  // Relations
  site      Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, hourUtc])
  @@map("hourly_summaries")
}

model DailyDigest {
  id           String   @id @default(cuid())
  siteId       String
  dayUtc       DateTime // midnight UTC
  energyKWh    Float
  avoidedTco2e Float    // energyKWh * baselineKgPerKWh / 1000
  rows         Int
  merkleRoot   String   // 0x...
  csvUrl       String?  // locker/IPFS pointer (optional)
  jsonUrl      String?
  anchored     Boolean  @default(false)
  adapterTxId  String?
  txHash       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  site         Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, dayUtc])
  @@map("daily_digests")
}
